# /srv/nginx/conf.d/saleor-api.conf
server {
  listen 8080;
  server_name saleor-api.dalekopro.hr;

  # security (opcionalno)
  add_header X-Content-Type-Options "nosniff" always;
  add_header X-Frame-Options "SAMEORIGIN" always;
  add_header Referrer-Policy "strict-origin-when-cross-origin" always;
  add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;

  # Health
  location = /health {
    proxy_pass http://saleor_api:8000/health/;
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-Proto https;
    proxy_set_header X-Forwarded-Host  $host;
    proxy_set_header X-Forwarded-Port  443;
  }

  # Glavni proxy (GraphQL i sve ostalo)
  location / {
    proxy_pass http://saleor_api:8000;
    proxy_http_version 1.1;

    proxy_set_header Host              $host;   # KLJUČNO
    proxy_set_header X-Real-IP         $remote_addr;
    proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto https;   # KLJUČNO
    proxy_set_header X-Forwarded-Host  $host;
    proxy_set_header X-Forwarded-Port  443;

    proxy_set_header Upgrade           $http_upgrade;
    proxy_set_header Connection        "upgrade";

    proxy_read_timeout 300s;
  }

  # MEDIA (apsolutni linkovi)
  location /media/ {
    proxy_pass http://saleor_api:8000/media/;
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-Proto https;
    proxy_set_header X-Forwarded-Host  $host;
    proxy_set_header X-Forwarded-Port  443;
    add_header Cache-Control "public, max-age=31536000, immutable";
  }

  # THUMBNAIL (apsolutni linkovi)
  location ^~ /thumbnail/ {
    proxy_pass http://saleor_api:8000/thumbnail/;
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-Proto https;
    proxy_set_header X-Forwarded-Host  $host;
    proxy_set_header X-Forwarded-Port  443;

    # (opcionalno cache)
    # proxy_cache      saleor_cache;
    # proxy_cache_valid 200 301 302 30d;
    # add_header       X-Cache-Status $upstream_cache_status;
  }
}
