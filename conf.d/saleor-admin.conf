# /srv/nginx/conf.d/saleor-admin.conf
# https://saleor-admin.dalekopro.hr  -->  saleor_dashboard:80
# GraphQL proxy s CORS-om  -->  saleor_api:8000/graphql

# Proxy cache za thumbnail-e (opcionalno, ali korisno)
proxy_cache_path /var/cache/nginx/saleor levels=1:2 keys_zone=saleor_cache:20m max_size=1g inactive=7d use_temp_path=off;

server {
  listen 8081;
  server_name saleor-admin.dalekopro.hr;

  # Security headeri (HTTPS-only domena)
  add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;
  add_header X-Content-Type-Options "nosniff" always;
  add_header X-Frame-Options "SAMEORIGIN" always;
  add_header Referrer-Policy "strict-origin-when-cross-origin" always;

  # -------- React Dashboard (SPA) --------
  # Napomena: sub_filter ispravlja sve hardkodirane "http://localhost:8000/*" u bundlovima
  location / {
    proxy_pass         http://saleor_dashboard:80;
    proxy_http_version 1.1;

    proxy_set_header   Host              $host;
    proxy_set_header   X-Real-IP         $remote_addr;
    proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
    proxy_set_header   X-Forwarded-Proto https;
    proxy_set_header   X-Forwarded-Host  $host;
    proxy_set_header   X-Forwarded-Port  443;

    # WebSocket (ako ikad zatreba)
    proxy_set_header   Upgrade           $http_upgrade;
    proxy_set_header   Connection        "upgrade";

    # --- SUB FILTER: popravi hardkodirani backend na javni API URL ---
    # Radi i za /graphql/ i za /thumbnail/ i sve ostalo pod 8000.
    sub_filter_once off;
    sub_filter_types *;
    proxy_set_header   Accept-Encoding "";  # tražimo nekomprimirano da bi sub_filter radio

    sub_filter "http://localhost:8000/graphql/" "https://saleor-api.dalekopro.hr/graphql/";
    sub_filter "http://localhost:8000/"         "https://saleor-api.dalekopro.hr/";

    # Safety net protiv mixed-content-a (browser sam diže http->https)
    add_header Content-Security-Policy "upgrade-insecure-requests" always;
  }

  # -------- Statika iz dashboarda: dugi cache --------
  location ~* \.(?:js|css|map|woff2?|ttf|eot|svg|png|jpe?g|gif|webp)$ {
    proxy_pass         http://saleor_dashboard:80;
    proxy_http_version 1.1;
    proxy_set_header   Host $host;
    proxy_set_header   X-Forwarded-Proto https;

    # Dugi cache za fingerprintane assete
    add_header Cache-Control "public, max-age=31536000, immutable";
  }

  # -------- Thumbnaili preko admin domene (cacheirani) --------
  location ^~ /thumbnail/ {
    proxy_pass         http://saleor_api:8000;  # zadržavamo originalne puteve
    proxy_http_version 1.1;

    proxy_set_header   Host              $host;
    proxy_set_header   X-Real-IP         $remote_addr;
    proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
    proxy_set_header   X-Forwarded-Proto https;
    proxy_set_header   X-Forwarded-Host  $host;
    proxy_set_header   X-Forwarded-Port  443;

    proxy_cache        saleor_cache;
    proxy_cache_valid  200 301 302 30d;
    add_header         X-Cache-Status $upstream_cache_status;
  }

  # -------- Direktan proxy na GraphQL s CORS-om --------
  location /graphql/ {
    # CORS
    add_header Access-Control-Allow-Origin $http_origin always;
    add_header Access-Control-Allow-Credentials true always;
    add_header Access-Control-Allow-Methods "GET, POST, OPTIONS" always;
    add_header Access-Control-Allow-Headers "Content-Type, Authorization, X-CSRFToken, X-Requested-With, apollo-require-preflight, apollographql-client-name, apollographql-client-version, $http_access_control_request_headers" always;
    add_header Vary "Origin" always;

    # Sakrij CORS headere iz backenda da ne budu dupli
    proxy_hide_header Access-Control-Allow-Origin;
    proxy_hide_header Access-Control-Allow-Credentials;
    proxy_hide_header Access-Control-Allow-Headers;
    proxy_hide_header Access-Control-Allow-Methods;
    proxy_hide_header Vary;

    # Preflight
    if ($request_method = OPTIONS) { return 204; }

    proxy_pass         http://saleor_api:8000/graphql/;
    proxy_http_version 1.1;
    proxy_read_timeout 300s;

    proxy_set_header   Host              $host;
    proxy_set_header   X-Real-IP         $remote_addr;
    proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
    proxy_set_header   X-Forwarded-Proto https;
    proxy_set_header   X-Forwarded-Host  $host;
    proxy_set_header   X-Forwarded-Port  443;

    proxy_set_header   Upgrade           $http_upgrade;
    proxy_set_header   Connection        "upgrade";
  }
}
